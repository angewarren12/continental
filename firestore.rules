rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user role
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user is manager
    function isManager() {
      return isAuthenticated() && getUserRole() == 'manager';
    }
    
    // Helper function to check if user is client
    function isClient() {
      return isAuthenticated() && getUserRole() == 'client';
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own data
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Managers can read all users
      allow read: if isManager();
      // Users can create their own document
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Users can update their own data (except role and totalSpent)
      allow update: if isAuthenticated() && request.auth.uid == userId 
        && (!('role' in request.resource.data.diff(resource.data).changedKeys()))
        && (!('totalSpent' in request.resource.data.diff(resource.data).changedKeys()));
      // Managers can update any user
      allow update: if isManager();
    }
    
    // Products collection
    match /products/{productId} {
      // Everyone can read active products
      allow read: if resource.data.isActive == true;
      // Managers can read all products
      allow read: if isManager();
      // Only managers can create, update, delete products
      allow create, update, delete: if isManager();
    }
    
    // Stock collection
    match /stock/{stockId} {
      // Only managers can read stock
      allow read: if isManager();
      // Only managers can create, update stock
      allow create, update: if isManager();
    }
    
    // Stock movements collection
    match /stockMovements/{movementId} {
      // Only managers can read stock movements
      allow read: if isManager();
      // Only managers can create stock movements
      allow create: if isManager();
    }
    
    // Orders collection
    match /orders/{orderId} {
      // Clients can read their own orders
      allow read: if isAuthenticated() && resource.data.clientId == request.auth.uid;
      // Managers can read all orders
      allow read: if isManager();
      // Only managers can create orders
      allow create: if isManager();
      // Managers can update orders
      allow update: if isManager();
      // Clients can read their own orders but cannot modify them
    }
  }
}
